#!/usr/bin/env ruby

require_relative "../lib/lead_flow"
require "dotenv/load"
require "logger"

# Set up logging to a file, rotating it when it hits 1MB, keeping 3 old logs
log_file = File.join(File.dirname(__FILE__), "../db/lead_flow.log")
Dir.mkdir("db") unless Dir.exist?("db")
logger = Logger.new(log_file, 3, 1024 * 1024)

# Use a clean format: [Timestamp] LEVEL: Message
logger.formatter = proc { |severity, datetime, progname, msg|
  "#{datetime.strftime('%Y-%m-%d %H:%M:%S')} #{severity}: #{msg}\n"
}

# Configuration
KEYWORDS = ENV.fetch("MONITOR_KEYWORDS", "").split(",")
SUBREDDITS = ENV.fetch("REDDIT_SUBREDDITS", "freelance,smallbusiness").split(",")
USER_AGENT = ENV["REDDIT_USER_AGENT"]
BUSINESS_CONTEXT = ENV["BUSINESS_CONTEXT"]
BUSINESS_SOLUTIONS = ENV["BUSINESS_SOLUTIONS"]

logger.info("Starting Scan: #{SUBREDDITS.join(', ')}")

begin
  filter = LeadFlow::Core::Filter.new(keywords: KEYWORDS)
  deduplicator = LeadFlow::Core::Deduplicator.new(storage_path: "db/seen_ids.txt")
  evaluator = LeadFlow::Core::Evaluator.new(provider: :gemini_cli)
  notifier = LeadFlow::Notifiers::Discord.new(webhook_url: ENV["DISCORD_WEBHOOK_URL"])

  SUBREDDITS.each_with_index do |subreddit, index|
    begin
      connector = LeadFlow::Connectors::RedditJson.new(
        subreddit: subreddit,
        user_agent: USER_AGENT
      )

      leads = connector.fetch(limit: 100)
      
      found_count = 0
      leads.each do |lead|
        next if deduplicator.duplicate?(lead.external_id)

        if filter.match?(lead)
          puts "\nPotential Lead Found: [#{lead.source}] #{lead.title}"
          puts "URL: #{lead.url}"
          print "Evaluating Intent... "

          confirmed, reasoning = evaluator.confirm_intent?(
            lead,
            business_context: BUSINESS_CONTEXT,
            business_solutions: BUSINESS_SOLUTIONS
          )

          if confirmed
            puts "âœ… CONFIRMED"
            puts "   Reason: #{reasoning}" if reasoning

            found_count += 1
            notifier.notify(lead, reasoning: reasoning)
            File.open("db/confirmed_leads.log", "a") do |f|
              f.puts "[#{Time.now.strftime('%Y-%m-%d %H:%M')}] #{lead.title}"
              f.puts "URL: #{lead.url}"
              f.puts "Reason: #{reasoning}" if reasoning
              f.puts "-" * 40
            end
          end
        end
      end
      
      logger.info("Finished r/#{subreddit}. Potential leads confirmed: #{found_count}")

      sleep(rand(3..8)) if index < SUBREDDITS.size - 1
    rescue StandardError => e
      logger.error("Failed r/#{subreddit}: #{e.message}")
    end
  end
  
  puts "Scan Complete."
  logger.info("Scan Complete.")
  logger.info("--------------")

rescue Interrupt, StandardError => e
  logger.fatal("Critical Script Failure: #{e.message}\n#{e.backtrace.join("\n")}")
end