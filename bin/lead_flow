#!/usr/bin/env ruby

require_relative "../lib/lead_flow"
require "dotenv/load"

# Configuration
KEYWORDS = ENV.fetch("MONITOR_KEYWORDS", "").split(",")
SUBREDDITS = ENV.fetch("REDDIT_SUBREDDITS", "freelance,smallbusiness").split(",")
USER_AGENT = ENV["REDDIT_USER_AGENT"]
AI_KEY = ENV["AI_API_KEY"]
BUSINESS_CONTEXT = ENV["BUSINESS_CONTEXT"]
BUSINESS_SOLUTIONS = ENV["BUSINESS_SOLUTIONS"]

puts "ğŸš€ Lead Flow Engine Started..."
puts "----------------------------------------"
puts "Monitoring Keywords: #{KEYWORDS.join(', ')}"
puts "Subreddits: #{SUBREDDITS.join(', ')}"
puts "----------------------------------------"

# Initialize Core Components
filter = LeadFlow::Core::Filter.new(keywords: KEYWORDS)
deduplicator = LeadFlow::Core::Deduplicator.new(storage_path: "db/seen_ids.txt")
evaluator = LeadFlow::Core::Evaluator.new(provider: :gemini_cli)
notifier = LeadFlow::Notifiers::Discord.new(webhook_url: ENV["DISCORD_WEBHOOK_URL"])

SUBREDDITS.each do |subreddit|
  begin
    puts "ğŸ” Scanning r/#{subreddit}..."
    
    connector = LeadFlow::Connectors::RedditJson.new(
      subreddit: subreddit,
      user_agent: USER_AGENT
    )

    leads = connector.fetch(limit: 10)

    leads.each do |lead|
      # Step 1: Check for duplicates
      next if deduplicator.duplicate?(lead.external_id)

      # Step 2: Filter noise (Regex)
      if filter.match?(lead)
        puts "\nâœ¨ Potential Lead Found: [#{lead.source}] #{lead.title}"
        puts "URL: #{lead.url}"

        # Step 3: AI Evaluation
        print "ğŸ§  Evaluating Intent... "
        
        confirmed, reasoning = evaluator.confirm_intent?(
          lead, 
          business_context: BUSINESS_CONTEXT, 
          business_solutions: BUSINESS_SOLUTIONS
        )

        if confirmed
          puts "âœ… CONFIRMED"
          puts "   Reason: #{reasoning}" if reasoning
          
          # Send Live Notification
          notifier.notify(lead, reasoning: reasoning)

          # Log the confirmed lead
          File.open("db/confirmed_leads.log", "a") do |f|
            f.puts "[#{Time.now.strftime('%Y-%m-%d %H:%M')}] #{lead.title}"
            f.puts "URL: #{lead.url}"
            f.puts "Reason: #{reasoning}" if reasoning
            f.puts "-" * 40
          end
        else
          puts "âŒ DISCARDED"
          puts "   Reason: #{reasoning}" if reasoning
        end
      end
    end
  rescue StandardError => e
    puts "âš ï¸ Error scanning r/#{subreddit}: #{e.message}"
  end
end

puts "\nâœ… Scan Complete."
